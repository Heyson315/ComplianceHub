name: Compliance Governance CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML files..."
          for file in $(find . -name "*.yaml" -o -name "*.yml" | grep -v node_modules); do
            echo "Checking $file"
            yamllint -d relaxed "$file" || echo "Warning: $file has issues (non-blocking)"
          done
        continue-on-error: true

  validate-powershell:
    name: Validate PowerShell Scripts
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Write-Host "Validating PowerShell scripts..." -ForegroundColor Cyan
          $scripts = Get-ChildItem -Recurse -Filter "*.ps1"
          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.Name)" -ForegroundColor White
            Invoke-ScriptAnalyzer -Path $script.FullName -Severity Warning
          }

  validate-policies:
    name: Validate Compliance Policy Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check policy templates exist
        run: |
          echo "Checking for required policy templates..."
          if [ -d "docs/policies" ]; then
            echo "✅ Policy directory exists"
            ls -la docs/policies/
          else
            echo "⚠️  Policy directory not found"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run TruffleHog secret scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
        continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-powershell, validate-policies, security-scan]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ✅ Compliance Governance CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** compliance-governance-test" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- YAML validation completed" >> $GITHUB_STEP_SUMMARY
          echo "- PowerShell validation completed" >> $GITHUB_STEP_SUMMARY
          echo "- Policy templates verified" >> $GITHUB_STEP_SUMMARY
          echo "- Security scans completed" >> $GITHUB_STEP_SUMMARY
